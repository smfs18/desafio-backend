# ğŸ—ï¸ ARCHITECTURE DIAGRAM

## Fluxo de RequisiÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CLIENT (HTTP)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â”‚ POST /api/v1/abastecimentos
                         â”‚ GET /api/v1/abastecimentos
                         â”‚ GET /health
                         â”‚ X-API-Key: <key>
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FASTAPI ROUTER LAYER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ health.py        â”‚  â”‚ motoristas.py    â”‚  â”‚abastecimentos.py â”‚  â”‚
â”‚  â”‚ /health          â”‚  â”‚ POST /motoristas â”‚  â”‚POST /abastecime  â”‚  â”‚
â”‚  â”‚ GET /motoristas  â”‚  â”‚GET  /motoristas  â”‚  â”‚GET  /abastecime  â”‚  â”‚
â”‚  â”‚                  â”‚  â”‚PATCH /motoristas â”‚  â”‚POST /approve     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                     â”‚                      â”‚             â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                 â”‚                                     â”‚
â”‚                      âœ“ ValidaÃ§Ã£o Pydantic                           â”‚
â”‚                      âœ“ Type Hints                                    â”‚
â”‚                      âœ“ API Key Check                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SERVICE LAYER (Business Logic)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ abastecimento_service.py     â”‚  â”‚ anomaly_service.py         â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ create_abastecimento()       â”‚  â”‚ detect_anomaly()           â”‚  â”‚
â”‚  â”‚  - Orquestra lÃ³gica          â”‚  â”‚  - Calcula preÃ§o/litro     â”‚  â”‚
â”‚  â”‚  - Chama anomaly_service     â”‚  â”‚  - Compara com threshold   â”‚  â”‚
â”‚  â”‚  - Define status             â”‚  â”‚  - Retorna bool            â”‚  â”‚
â”‚  â”‚                              â”‚  â”‚                            â”‚  â”‚
â”‚  â”‚ approve_abastecimento()      â”‚  â”‚ get_anomaly_score()        â”‚  â”‚
â”‚  â”‚ reject_abastecimento()       â”‚  â”‚  - Score 0.0 a 1.0        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  Sem conhecimento de: FastAPI, HTTP, Banco                          â”‚
â”‚  FÃ¡cil de testar isoladamente                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              REPOSITORY LAYER (Data Access)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ abastecimento_repository.py  â”‚  â”‚ motorista_repository.py    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ create(obj: Abastecimento)   â”‚  â”‚ create(obj: Motorista)     â”‚  â”‚
â”‚  â”‚ get_by_id(id: int)           â”‚  â”‚ get_by_id(id: int)         â”‚  â”‚
â”‚  â”‚ get_all()                    â”‚  â”‚ get_by_cpf(cpf: str)       â”‚  â”‚
â”‚  â”‚ get_with_pagination()        â”‚  â”‚ get_by_email(email: str)   â”‚  â”‚
â”‚  â”‚ get_by_status()              â”‚  â”‚ get_with_pagination()      â”‚  â”‚
â”‚  â”‚ get_anomalies()              â”‚  â”‚ get_active()               â”‚  â”‚
â”‚  â”‚ count_by_status()            â”‚  â”‚                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                  â–²                                                    â”‚
â”‚                  â”‚                                                    â”‚
â”‚           base.py (Generic CRUD)                                    â”‚
â”‚           â”œâ”€â”€ create()                                              â”‚
â”‚           â”œâ”€â”€ get_by_id()                                           â”‚
â”‚           â”œâ”€â”€ update()                                              â”‚
â”‚           â”œâ”€â”€ delete()                                              â”‚
â”‚           â””â”€â”€ count()                                               â”‚
â”‚                                                                      â”‚
â”‚           âœ“ SQLAlchemy async                                        â”‚
â”‚           âœ“ FÃ¡cil de mockar                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DOMAIN LAYER (Data Models)                         â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ models/                        â”‚  â”‚ schemas/                 â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ motorista.py (ORM)             â”‚  â”‚motorista.py (Pydantic)   â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ id: int (PK)               â”‚  â”‚â”œâ”€â”€ MotoristaCreate       â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ nome: str                  â”‚  â”‚â”œâ”€â”€ MotoristaUpdate       â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ cpf: str (UNIQUE)          â”‚  â”‚â””â”€â”€ MotoristaResponse     â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ email: str (UNIQUE)        â”‚  â”‚                          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ telefone: str              â”‚  â”‚abastecimento.py          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ ativo: bool                â”‚  â”‚â”œâ”€â”€ AbastecimentoCreate   â”‚  â”‚
â”‚  â”‚ â””â”€â”€ timestamps                 â”‚  â”‚â”œâ”€â”€ AbastecimentoResponse â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚â””â”€â”€ AbastecimentoList...  â”‚  â”‚
â”‚  â”‚ abastecimento.py (ORM)         â”‚  â”‚                          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ id: int (PK)               â”‚  â”‚validators/               â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ motorista_id: int (FK)     â”‚  â”‚â””â”€â”€ cpf.py                â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ tipo_combustivel: Enum     â”‚  â”‚    â”œâ”€â”€ validate_cpf()    â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ valor: float               â”‚  â”‚    â””â”€â”€ format_cpf()      â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ litros: float              â”‚  â”‚                          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ status: Enum               â”‚  â”‚enums.py                 â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ eh_anomalia: bool          â”‚  â”‚â”œâ”€â”€ StatusAbastecimento   â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ motivo_recusa: str         â”‚  â”‚â””â”€â”€ TipoCombustivel       â”‚  â”‚
â”‚  â”‚ â””â”€â”€ timestamps                 â”‚  â”‚                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  CORE LAYER (Infrastructure)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ config.py                      â”‚  â”‚ database.py              â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Settings (Pydantic)        â”‚  â”‚â”œâ”€â”€ Base (DeclarativeBase)â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ DATABASE_URL               â”‚  â”‚â”œâ”€â”€ engine (AsyncEngine)  â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ ENVIRONMENT                â”‚  â”‚â”œâ”€â”€ async_session_maker   â”‚  â”‚
â”‚  â”‚ â””â”€â”€ API_KEY                    â”‚  â”‚â”œâ”€â”€ get_session()         â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚â”œâ”€â”€ init_db()             â”‚  â”‚
â”‚  â”‚ security.py                    â”‚  â”‚â””â”€â”€ dispose_db()          â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ verify_api_key()           â”‚  â”‚                          â”‚  â”‚
â”‚  â”‚ â””â”€â”€ APIKeyHeader               â”‚  â”‚ logging.py               â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚ â””â”€â”€ logger setup         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚           âœ“ Pydantic Settings (.env)                               â”‚
â”‚           âœ“ SQLAlchemy AsyncEngine                                 â”‚
â”‚           âœ“ asyncpg driver                                         â”‚
â”‚           âœ“ API Key authentication                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE LAYER                                 â”‚
â”‚                   PostgreSQL 16 + asyncpg                           â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ motoristas table               â”‚  â”‚ abastecimentos table     â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ id (PK)                        â”‚  â”‚ id (PK)                  â”‚  â”‚
â”‚  â”‚ nome (varchar)                 â”‚  â”‚ motorista_id (FK)        â”‚  â”‚
â”‚  â”‚ cpf (varchar, UNIQUE)          â”‚  â”‚ tipo_combustivel         â”‚  â”‚
â”‚  â”‚ email (varchar, UNIQUE)        â”‚  â”‚ valor (float)            â”‚  â”‚
â”‚  â”‚ telefone (varchar)             â”‚  â”‚ litros (float)           â”‚  â”‚
â”‚  â”‚ ativo (boolean)                â”‚  â”‚ status (varchar)         â”‚  â”‚
â”‚  â”‚ criado_em (timestamp)          â”‚  â”‚ motivo_recusa (varchar)  â”‚  â”‚
â”‚  â”‚ atualizado_em (timestamp)      â”‚  â”‚ eh_anomalia (boolean)    â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚ data_abastecimento       â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚ criado_em (timestamp)    â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚ atualizado_em (timestamp)â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚                          â”‚  â”‚
â”‚  â”‚ Indexes:                       â”‚  â”‚ Indexes:                 â”‚  â”‚
â”‚  â”‚ - cpf (UNIQUE)                 â”‚  â”‚ - motorista_id (FK)      â”‚  â”‚
â”‚  â”‚ - email (UNIQUE)               â”‚  â”‚ - status                 â”‚  â”‚
â”‚  â”‚ - ativo                        â”‚  â”‚ - eh_anomalia            â”‚  â”‚
â”‚  â”‚                                â”‚  â”‚ - data_abastecimento     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                      â”‚
â”‚           Gerenciado por Alembic (versionado)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Camadas e Responsabilidades

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    EXTERNAL INTERFACE (HTTP)                         â”‚
â”‚         {"motorista_id": 1, "valor": 250, "litros": 40}            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŒ ROUTERS - Responsabilidade: HTTP                               â”‚
â”‚     âœ“ Receber requisiÃ§Ãµes HTTP                                     â”‚
â”‚     âœ“ Validar com Pydantic                                          â”‚
â”‚     âœ“ Chamar service                                               â”‚
â”‚     âœ“ Retornar response HTTP                                        â”‚
â”‚     âœ— SEM regra de negÃ³cio                                         â”‚
â”‚     âœ— SEM SQL direto                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’¼ SERVICES - Responsabilidade: LÃ³gica de NegÃ³cio                â”‚
â”‚     âœ“ Implementar regras de negÃ³cio                                â”‚
â”‚     âœ“ Orquestrar repositories                                      â”‚
â”‚     âœ“ Detectar anomalias (25%)                                     â”‚
â”‚     âœ“ Independente de FastAPI                                      â”‚
â”‚     âœ“ FÃ¡cil de testar isoladamente                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—‚ï¸ REPOSITORIES - Responsabilidade: Acesso a Dados               â”‚
â”‚     âœ“ Executar queries SQLAlchemy                                  â”‚
â”‚     âœ“ CRUD genÃ©rico (base.py)                                      â”‚
â”‚     âœ“ Queries especÃ­ficas por modelo                               â”‚
â”‚     âœ“ FÃ¡cil de mockar em testes                                    â”‚
â”‚     âœ— SEM lÃ³gica de negÃ³cio                                        â”‚
â”‚     âœ— SEM transformaÃ§Ãµes de dados                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ DOMAIN - Responsabilidade: Dados e Contratos                  â”‚
â”‚     âœ“ Models (ORM) - Mapeamento banco                              â”‚
â”‚     âœ“ Schemas (Pydantic) - Contrato API                            â”‚
â”‚     âœ“ Validators - Regras reutilizÃ¡veis                            â”‚
â”‚     âœ“ Enums - Tipos compartilhados                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ CORE - Responsabilidade: Infraestrutura                        â”‚
â”‚     âœ“ ConfiguraÃ§Ã£o (Settings)                                      â”‚
â”‚     âœ“ Database (SQLAlchemy setup)                                   â”‚
â”‚     âœ“ Security (API Key)                                           â”‚
â”‚     âœ“ Logging                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ—„ï¸ DATABASE - PostgreSQL + asyncpg                               â”‚
â”‚     PersistÃªncia e recuperaÃ§Ã£o de dados                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Fluxo Completo: Criar Abastecimento

```
1. CLIENT SENDS REQUEST
   POST /api/v1/abastecimentos
   {
     "motorista_id": 1,
     "tipo_combustivel": "gasolina",
     "valor": 250.00,
     "litros": 40.0
   }

2. ROUTER (abastecimentos.py)
   â”œâ”€â”€ Recebe request
   â”œâ”€â”€ Valida com Pydantic (AbastecimentoCreate)
   â”œâ”€â”€ Verifica API Key
   â”œâ”€â”€ ObtÃ©m session do banco
   â””â”€â”€ Chama service.create_abastecimento()

3. SERVICE (abastecimento_service.py)
   â”œâ”€â”€ Cria objeto Abastecimento
   â”œâ”€â”€ Chama anomaly_service.detect_anomaly()
   â”‚   â””â”€â”€ Calcula: 250 / 40 = 6.25 R$/L (< 8.12) â†’ Normal
   â”œâ”€â”€ Define status = "pendente"
   â”œâ”€â”€ Chama repository.create()
   â””â”€â”€ Retorna objeto criado

4. REPOSITORY (abastecimento_repository.py)
   â”œâ”€â”€ Adiciona objeto Ã  sessÃ£o
   â”œâ”€â”€ Executa SQL INSERT
   â”œâ”€â”€ Commit na transaÃ§Ã£o
   â””â”€â”€ Retorna objeto com ID gerado

5. DATABASE (PostgreSQL)
   â”œâ”€â”€ Insere em motoristas
   â”œâ”€â”€ Insere em abastecimentos
   â”œâ”€â”€ Aplica Ã­ndices
   â””â”€â”€ Confirma transaÃ§Ã£o

6. ROUTER RESPONSE
   â”œâ”€â”€ Serializa com Pydantic (AbastecimentoResponse)
   â”œâ”€â”€ Status HTTP 201 (Created)
   â””â”€â”€ Response:
       {
         "id": 1,
         "motorista_id": 1,
         "tipo_combustivel": "gasolina",
         "valor": 250.00,
         "litros": 40.0,
         "status": "pendente",
         "eh_anomalia": false,
         "data_abastecimento": "2024-01-19T...",
         "criado_em": "2024-01-19T..."
       }

7. CLIENT RECEIVES RESPONSE
```

---

## ğŸ§ª Exemplo: DetecÃ§Ã£o de Anomalia

```
NORMAL CASE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Valor: R$ 250.00                                    â”‚
â”‚ Litros: 40.0                                        â”‚
â”‚ PreÃ§o/Litro: 250 / 40 = R$ 6.25/L                  â”‚
â”‚ Threshold: R$ 8.12/L (25% acima de R$ 6.50)        â”‚
â”‚ Resultado: 6.25 < 8.12 â†’ âœ… NORMAL                â”‚
â”‚ Status: "pendente"                                  â”‚
â”‚ eh_anomalia: false                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ANOMALY CASE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Valor: R$ 600.00                                    â”‚
â”‚ Litros: 20.0                                        â”‚
â”‚ PreÃ§o/Litro: 600 / 20 = R$ 30.00/L                 â”‚
â”‚ Threshold: R$ 8.12/L                                â”‚
â”‚ Resultado: 30.00 > 8.12 â†’ âš ï¸ ANOMALIA             â”‚
â”‚ Status: "anomalia"                                  â”‚
â”‚ eh_anomalia: true                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Escalabilidade

Esta arquitetura suporta:

- âœ… **Alta ConcorrÃªncia**: async/await + asyncpg
- âœ… **Leitura Pesada**: Ãndices estratÃ©gicos
- âœ… **Cache**: Redis-ready (futuro)
- âœ… **MÃºltiplas VersÃµes**: `/api/v1`, `/api/v2`
- âœ… **Testes**: 100% mockÃ¡vel
- âœ… **Deployment**: Docker + Kubernetes-ready
- âœ… **Monitoramento**: Health check + Logging

